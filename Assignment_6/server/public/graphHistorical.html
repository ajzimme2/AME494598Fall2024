<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script src='asyncReq.js'></script>
    
    <script>
    var chart;
    var lastAddedTS = 0;
    var duration = 10;  // Default duration (in minutes)

	function getDataFromServer(startTime, duration) {
		var url = "./getData?start=" + startTime + "&duration=" + duration;
		console.log("Fetching data with URL:", url);  // Debugging log
		var callback = function(data) {
		console.log("Data received from server:", data);
		var obj = JSON.parse(data);
		var columns = [["x"], ["Temperature"], ["Humidity"]];

		if (obj.length > 0) {
			// Only update leftmost timestamp if the data covers the full duration
			var firstTimestamp = parseInt(obj[0].time);
			var lastTimestamp = parseInt(obj[obj.length - 1].time);

			// Check if we have enough data to fill the full range (duration)
			if (lastTimestamp - firstTimestamp < (duration * 60 * 1000)) {
				console.log("Not enough data to cover full duration.");
				// Don't update the leftmost timestamp
			} else {
				// Update the leftmost timestamp to the first data point's timestamp
				lastAddedTS = lastTimestamp;
			}

			// Process the data to add to the graph
			for (var i = 0; i < obj.length; i++) {
				var timestamp = parseInt(obj[i].time);
				columns[0].push(getTSInFormat(timestamp));
				columns[1].push(obj[i].t || 0);
				columns[2].push(obj[i].h || 0);
				lastAddedTS = timestamp;  // Update the last timestamp
			}

			// Update the chart with the new data
			chart.load({
				columns: columns
			});
		} else {
			console.log("No data available for the selected range.");
		}};
		loadFile(url, callback);
	}

	function getTSInFormat(t) {
    var x = new Date(t); // Make sure we're passing the correct timestamp (in milliseconds)
    // Add leading zeros to hours, minutes, and seconds for consistency
    return x.getFullYear() + "-" + (x.getMonth() + 1).toString().padStart(2, '0') + "-" + x.getDate().toString().padStart(2, '0') + "T" +
        x.getHours().toString().padStart(2, '0') + ":" +
        x.getMinutes().toString().padStart(2, '0') + ":" +
        x.getSeconds().toString().padStart(2, '0');
}

    function start() {
        flatpickr("#datetimeSelect", { enableTime: true, dateFormat: "Y-m-d H:i" });

        var url = "./getLatest";
        var callback = function(data) {
            var obj = JSON.parse(data);
            var columns = [["x"],["Temperature"],["Humidity"]];
            for (var i = 0; i < obj.length; i++) {
                var timestamp = parseInt(obj[i].time);
                columns[0].push(getTSInFormat(timestamp));
                columns[1].push(obj[i].t || 0);
                columns[2].push(obj[i].h || 0);
                lastAddedTS = timestamp;
            }
            chart = c3.generate({
                bindto: '#data',
                data: {
                    x: 'x',
                    xFormat: '%Y-%m-%dT%H:%M:%S',
                    columns: columns
                },
                axis: {
                    x: {
                        type: 'timeseries',
                        tick: {
                            format: '%H:%M:%S, %Y-%m-%d',
                        }
                    }
                }
            });
        };

        loadFile(url, callback);

        // Update data at a reasonable interval (e.g., every minute)
        setInterval(function() {
            getDataFromServer(lastAddedTS, duration);  // Use lastAddedTS and duration
        }, 6000);  // Update every minute (adjust as necessary)
    }

    // Listen for changes to the dropdown and update the duration
    document.addEventListener("DOMContentLoaded", function() {
        // This ensures the dropdown is updated after the DOM is fully loaded
        var durationSelect = document.getElementById("duration");
        durationSelect.addEventListener("change", function() {
            duration = parseInt(this.value);  // Update the global duration variable
            console.log("Selected Duration:", duration);  // Debugging log

            // Re-fetch data based on the updated duration
            const selectedStartTime = document.getElementById("datetimeSelect")._flatpickr.selectedDates[0];
            if (selectedStartTime) {
                const startTime = selectedStartTime.getTime() / 1000;  // Convert to seconds
                console.log("Converted Start Time (in seconds):", startTime);  // Debugging log
                getDataFromServer(startTime, duration);  // Fetch and update the chart
            }
        });

        // This is for clicking on the chart to trigger data fetch
        document.getElementById("data").addEventListener("click", function() {
            // Get the selected start time and duration
            const selectedStartTime = document.getElementById("datetimeSelect")._flatpickr.selectedDates[0];  // Get the first selected date
            duration = parseInt(document.getElementById("duration").value);  // Update global duration based on the dropdown selection
            if (selectedStartTime && duration) {
                const startTime = selectedStartTime.getTime() / 1000;  // Convert to seconds
                console.log("Selected Start Time:", startTime);  // Debugging log
                getDataFromServer(startTime, duration);  // Fetch and update the chart
            }
        });
    });

    </script>
</head>

<body style='text-align:center; font-family:Helvetica' onload='start()'>
    <h1> Weather Historical Data </h1>

    <input id='datetimeSelect' type='text'>
    <select id='duration'>
        <option value='10'> last 10 mins </option>
        <option value='30'> last 30 mins </option>
        <option value='60'> last hour </option>
    </select>
    <div id='data'></div>

</body>
</html>